name: showcase-autotest
run-name: Submit workflow for periodic testing
on: 
    workflow_dispatch:
    schedule:
    # Every Wednesday at 2am
    - cron: '0 2 * * 3'


jobs:
    getdate:
        runs-on: ubuntu-latest
        steps:
            - name: "Get current date"
              run: |
                echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
              id: date
        outputs:
            date: ${{ steps.date.outputs.date }}

    runtest:
        runs-on: ubuntu-latest
        name: ${{ matrix.pipeline.name }}.${{ matrix.compute_env.name }}
        needs: getdate
        continue-on-error: true
        strategy:
            matrix:
                pipeline:
                    - { name: rnaseq, url: 'https://github.com/nf-core/rnaseq', org: nf-core, rev: master, latest: true }
                    - { name: sarek, url: 'https://github.com/nf-core/sarek', org: nf-core, rev: master, latest: true }
                compute_env:
                   - { name: scidev_testing_aws, ref: TOWER_CE_AWS_CPU, workdir: TOWER_BUCKET_AWS, workspace_id: TOWER_WORKSPACE_ID }
                   - { name: scidev_aws_aws, ref: SCIDEV_CE_AWS_CPU, workdir: SCIDEV_BUCKET_AWS, workspace_id: SCIDEV_AWS_WORKSPACE_ID }
                      
        steps:
            - uses: seqeralabs/action-tower-launch@8ff078c8133a8ad2145a96752688a990198d6529
              with:
                pipeline: ${{ matrix.pipeline.url }}
                workspace_id: ${{ secrets[matrix.compute_env.workspace_id] }}
                access_token: ${{ secrets.TOWER_ACCESS_TOKEN }}
                compute_env: ${{ secrets[matrix.compute_env.ref] }}
                workdir: "${{ secrets[matrix.compute_env.workdir] }}/work/${{ matrix.pipeline.name }}/work-${{ needs.getdate.outputs.date }}"
                run_name: "${{ matrix.pipeline.name }}_${{ needs.getdate.outputs.date }}_${{ matrix.compute_env.name }}"
                revision: "${{ matrix.pipeline.rev }}"
                profiles: test
                wait: SUBMITTED
                parameters: |
                    {
                        "outdir": "${{ matrix[secrets.workdir] }}/${{ matrix.pipeline.name }}/results-test-${{ needs.getdate.outputs.date }}",
                        "hook_url": "${{ secrets.SLACK_HOOK_URL }}"
                    }

            - uses: actions/upload-artifact@v3
              if: success() || failure()
              with:
                name: ${{ matrix.pipeline.name }}_${{ matrix.compute_env.name }}_log
                path: tower_action_*.log

