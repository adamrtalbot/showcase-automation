name: manual-run-pipeline
run-name: manual-trigger
on:
  workflow_dispatch:
    inputs:
      pipelines:
        description: "Pipeline JSON string"
        type: string
        default: '{\"name\": \"hello\", \"url\": \"hello\", \"rev\": \"master\", \"latest\": true, \"profiles\": \"\"}'
      compute_envs:
        description: "Compute Environment JSON string"
        type: string
        default: '{\"name\": \"aws\", \"ref\": \"seqera_aws_ireland_fusionv2_nvme\", \"workdir\": \"s3://seqeralabs-showcase\", \"workspace_id\": \"138659136604200\"}'
      dryrun:
        description: "Dryrun (do not submit pipeline)"
        default: false
        type: boolean
        required: false
      timer:
        description: "Environment"
        default: delay120mins
        type: choice
        options:
          - noDelay
          - delay1mins
          - delay5mins
          - delay15mins
          - delay30mins
          - delay60mins
          - delay120mins
          - delay360mins
          - waitForReviewer
      slack:
        description: Slack hook
        type: boolean
        required: false
        default: true
      remove:
        description: Delete run
        default: true
        type: boolean
        required: false

jobs:
  load-matrix:
    runs-on: ubuntu-latest
    outputs:
      pipelines: ${{ steps.set-matrix.outputs.pipelines }}
      compute_envs: ${{ steps.set-matrix.outputs.compute_envs }}
    steps:
      - id: echo-inputs
        run: |
          echo ${{ inputs.pipelines }}
          echo ${{ inputs.compute_envs }}
      - id: set-matrix
        run: |
          echo 'pipelines=${{ inputs.pipelines }}' >> $GITHUB_OUTPUT
          echo 'compute_envs=${{ inputs.compute_envs }}' >> $GITHUB_OUTPUT

  autorun-pipeline:
    name: Run pipeline
    needs: load-matrix
    uses: ./.github/workflows/autorun.yml
    with:
      pipelines: ${{ needs.load-matrix.outputs.pipelines }}
      compute_envs: ${{ needs.load-matrix.outputs.compute_envs }}
      dryrun: ${{ inputs.dryrun }}
      timer: ${{ inputs.timer }}
      slack: ${{ inputs.slack }}
      remove: ${{ inputs.remove }}
    secrets: inherit
